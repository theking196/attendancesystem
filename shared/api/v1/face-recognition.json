{
  "version": "v1",
  "title": "Face Recognition Internal API",
  "description": "Internal JSON API contract between the PHP app and the Python face-recognition service.",
  "security": {
    "type": "hmac-sha256",
    "headers": [
      "X-Auth-Key",
      "X-Auth-Signature",
      "X-Auth-Timestamp",
      "X-Auth-Nonce"
    ],
    "requirements": [
      "Tokens must be provisioned via secure secret storage.",
      "Requests must be sent over TLS within the private network.",
      "Requests without valid HMAC headers must be rejected with AUTH_INVALID_TOKEN.",
      "The signature is computed from METHOD, PATH, TIMESTAMP, NONCE, and SHA-256(body)."
    ]
  },
  "endpoints": [
    {
      "name": "RecognizeFace",
      "method": "POST",
      "path": "/v1/recognize",
      "description": "Detects and recognizes a face from an image payload.",
      "request": {
        "contentType": "application/json",
        "schema": {
          "type": "object",
          "required": ["request_id", "image"],
          "properties": {
            "request_id": {
              "type": "string",
              "description": "Client-generated request identifier for tracing."
            },
            "image": {
              "type": "object",
              "required": ["content_type", "data_base64"],
              "properties": {
                "content_type": {
                  "type": "string",
                  "enum": ["image/jpeg", "image/png"],
                  "description": "MIME type of the image payload."
                },
                "data_base64": {
                  "type": "string",
                  "description": "Base64-encoded image bytes."
                }
              }
            },
            "confidence_threshold": {
              "type": "number",
              "minimum": 0,
              "maximum": 1,
              "description": "Optional override for the match confidence threshold."
            },
            "metadata": {
              "type": "object",
              "description": "Optional client metadata for auditing.",
              "additionalProperties": true
            }
          }
        }
      },
      "responses": {
        "200": {
          "description": "Recognition result.",
          "schema": {
            "type": "object",
            "required": ["request_id", "status", "faces"],
            "properties": {
              "request_id": { "type": "string" },
              "status": {
                "type": "string",
                "enum": ["recognized", "unrecognized", "no_face_detected"]
              },
              "faces": {
                "type": "array",
                "items": {
                  "type": "object",
                  "required": ["bounding_box", "confidence"],
                  "properties": {
                    "bounding_box": {
                      "type": "object",
                      "required": ["x", "y", "width", "height"],
                      "properties": {
                        "x": { "type": "integer" },
                        "y": { "type": "integer" },
                        "width": { "type": "integer" },
                        "height": { "type": "integer" }
                      }
                    },
                    "person_id": {
                      "type": "string",
                      "description": "Present when the face is recognized."
                    },
                    "confidence": {
                      "type": "number",
                      "minimum": 0,
                      "maximum": 1
                    }
                  }
                }
              },
              "processing_time_ms": { "type": "integer" }
            }
          }
        },
        "400": {
          "description": "Validation error.",
          "schema": { "$ref": "#/schemas/error" }
        },
        "401": {
          "description": "Authentication error.",
          "schema": { "$ref": "#/schemas/error" }
        },
        "422": {
          "description": "Image processing error.",
          "schema": { "$ref": "#/schemas/error" }
        },
        "500": {
          "description": "Unexpected service error.",
          "schema": { "$ref": "#/schemas/error" }
        }
      }
    },
    {
      "name": "EnrollValidate",
      "method": "POST",
      "path": "/v1/enroll-validate",
      "description": "Validates low-risk enrollment images before storage.",
      "request": {
        "contentType": "application/json",
        "schema": {
          "type": "object",
          "required": ["request_id", "person_id", "image", "risk_level"],
          "properties": {
            "request_id": {
              "type": "string",
              "description": "Client-generated request identifier for tracing."
            },
            "person_id": {
              "type": "string",
              "description": "The user identifier in the PHP domain."
            },
            "risk_level": {
              "type": "string",
              "enum": ["low"],
              "description": "Only low risk validations are allowed synchronously."
            },
            "image": {
              "type": "object",
              "required": ["content_type", "data_base64"],
              "properties": {
                "content_type": {
                  "type": "string",
                  "enum": ["image/jpeg", "image/png"],
                  "description": "MIME type of the image payload."
                },
                "data_base64": {
                  "type": "string",
                  "description": "Base64-encoded image bytes."
                }
              }
            }
          }
        }
      },
      "responses": {
        "200": {
          "description": "Validation result.",
          "schema": {
            "type": "object",
            "required": ["request_id", "status", "validation"],
            "properties": {
              "request_id": { "type": "string" },
              "status": {
                "type": "string",
                "enum": ["accepted", "rejected"]
              },
              "validation": {
                "type": "object",
                "required": ["person_id", "matches", "confidence"],
                "properties": {
                  "person_id": { "type": "string" },
                  "matches": { "type": "boolean" },
                  "confidence": { "type": "number" }
                }
              },
              "processing_time_ms": { "type": "integer" }
            }
          }
        },
        "400": {
          "description": "Validation error.",
          "schema": { "$ref": "#/schemas/error" }
        },
        "401": {
          "description": "Authentication error.",
          "schema": { "$ref": "#/schemas/error" }
        },
        "422": {
          "description": "Image processing error.",
          "schema": { "$ref": "#/schemas/error" }
        },
        "500": {
          "description": "Unexpected service error.",
          "schema": { "$ref": "#/schemas/error" }
        }
      }
    }
  ],
  "errorCodes": [
    {
      "code": "AUTH_MISSING_TOKEN",
      "httpStatus": 401,
      "message": "Missing authentication token."
    },
    {
      "code": "AUTH_INVALID_TOKEN",
      "httpStatus": 401,
      "message": "Authentication token is invalid."
    },
    {
      "code": "VALIDATION_FAILED",
      "httpStatus": 400,
      "message": "Request validation failed."
    },
    {
      "code": "IMAGE_DECODE_FAILED",
      "httpStatus": 422,
      "message": "Image could not be decoded or is corrupted."
    },
    {
      "code": "FACE_NOT_FOUND",
      "httpStatus": 422,
      "message": "No face detected in the image."
    },
    {
      "code": "INTERNAL_ERROR",
      "httpStatus": 500,
      "message": "Unexpected service error."
    }
  ],
  "schemas": {
    "error": {
      "type": "object",
      "required": ["request_id", "code", "message"],
      "properties": {
        "request_id": { "type": "string" },
        "code": { "type": "string" },
        "message": { "type": "string" },
        "details": {
          "type": "object",
          "additionalProperties": true
        }
      }
    }
  }
}
